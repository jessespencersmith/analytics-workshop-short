---
title: "EHR-Data-Example"
output: html_document
---

##Load libraries we need
```{r}
library(readr)
library(tidyverse)
library(assertr)
```


## Read in the data
```{r read in main data set}
# Read in full dataset
lumbar_df <- read_csv("~/Desktop/lumbar_full_df.csv") %>% 
  verify(has_all_names("fake_id", "odi_percent_1yr"))

# Look at the data
lumbar_df
```

##Check format of fake_id variable
```{r}
lumbar_df %>% select(fake_id)
```


## Make sure id column is in correct format
```{r}
lumbar_df_correct_id <- lumbar_df %>% mutate(fake_id = as.character(fake_id))

lumbar_df_correct_id %>% select(fake_id)
```


```{r read in additional demographic data}

# Read in the demographic data
lumbar_age_weight_height <- read_csv("~/Desktop/lumbar_age_weight_height.csv", 
    col_types = cols(fake_id = col_character())) %>% 
  verify(has_all_names("fake_id"))

# Look at data
lumbar_age_weight_height
```

##Rearrange columns so id is first
```{r}
lumbar_age_weight_height %>% select(fake_id, everything())
```


##Join the two datasets together
```{r}
# Only join the two datasets that have a matching fake_id value in both
inner_join(lumbar_df_correct_id, lumbar_age_weight_height, by = "fake_id")

```

Who did we drop? Let's investigate further.
```{r}
# Who did we drop?
anti_join(lumbar_df_correct_id, lumbar_age_weight_height, by = "fake_id") %>% select(fake_id)
```
##Fix the broken ids
```{r}
lumbar_df_new_id <- lumbar_df_correct_id %>%
  mutate(new_id = str_replace(fake_id, "000", ""))

# Did it work?
lumbar_df_new_id %>%
  select(new_id, fake_id) %>% 
  filter(fake_id == "101000")
```

##Join the datasets together
```{r}
# Throws an error
inner_join(lumbar_df_new_id, lumbar_age_weight_height, by = "new_id")
```

Tell the join what variables are the same
```{r}
# join the datasets together
lumbar_full_df <- inner_join(lumbar_df_new_id, lumbar_age_weight_height, by = c("new_id" = "fake_id"))
```


## Determine what variables are in the dataset
```{r}
# Look at names
lumbar_full_df %>% names()
```

Better way to look at variables
```{r}
# Better way to look at the names
lumbar_full_df %>% glimpse()
```

## Data manipulation
1. Drop all cpt codes
2. Drop variables with missing values?
```{r}
# Get rid of cpt codes
lumbar_no_cpt <- lumbar_full_df %>%
  select(-contains("cpt"))

# Did it work?
lumbar_no_cpt %>% glimpse()
```

# drop missing values
```{r}
lumbar_no_cpt %>% drop_na()
```

What happened? 

##Explore missing with data explorer
```{r}
library(DataExplorer)

lumbar_no_cpt %>% plot_missing()
```

What variables are causing the most missingness? Let's only keep variables that only have less than 5% missingness. 

```{r}
# Useful for dealing with missing values
library(naniar)

lumbar_no_miss <- lumbar_no_cpt %>%
  #This is a formula function
  select_if( ~ pct_miss(.) < 5) %>% 
  drop_na()

# Investigate again
lumbar_no_miss %>% glimpse()
```

##What variables did we just drop
```{r}
# What variables did we drop?
setdiff(names(lumbar_no_cpt), names(lumbar_no_miss))
```

## Select only variables we're interested in

Variables:

odi_percent_1yr
gender
race
age
diabetes
smoker
employment
height
weight
median_household_income
asthma

```{r}
# Variables we want to select
variables_to_select <- c("odi_percent_1yr",
                         "odi_percent_preop",
                         "gender", 
                         "race", 
                         "age", 
                         "diabetes",
                         "smoker", 
                         "employment", 
                         "height", 
                         "weight",
                         "median_household_income",
                         "asthma")

# Create new data set with just the variables we want
lumbar_final <- lumbar_no_miss %>%
  select(variables_to_select)
```

## Explore variables with Data Explorer

```{r}
# Boxplots
lumbar_final %>% 
  plot_boxplot(by = "odi_percent_1yr")
```

```{r}
# Barplots
lumbar_final %>% 
  plot_bar()
```

## How many observations do we have in race and employment?
```{r}
library(janitor)

# table
lumbar_final %>% tabyl(race)
```
# only keep 2 categories for race
```{r}
lumbar_final <- lumbar_final %>% 
  mutate(race_lumped = fct_lump(race, n = 2))

lumbar_final %>% tabyl(race_lumped)
```

## Check employment variable
```{r}
lumbar_final %>% tabyl(employment)
```

## Only keep if there are at least 200 observationsin the category
```{r}
lumbar_final <- lumbar_final %>% 
  mutate(employment_lumped = fct_lump_min(employment, min = 200))

# Did it work?
lumbar_final %>% tabyl(employment_lumped)
```

## Create change in ODI percent and view it in descending order
```{r}
lumbar_final <- lumbar_final %>% 
  mutate(odi_change = odi_percent_1yr - odi_percent_preop)

# Check that it worked
lumbar_final %>% 
  select(odi_change, everything()) %>% 
  arrange(desc(odi_change))
```

##Does smoking have an affect, on average, for change in ODI score?
```{r}
# difference among smoking groups
lumbar_final %>% 
  group_by(smoker) %>% 
  summarise(avg_odi_change = mean(odi_change))
```


## Do men or women who smoke have a larger change in ODI score, on average? 
```{r}
# By gender
lumbar_final %>% 
  group_by(gender) %>% 
  summarise(avg_odi_change = mean(odi_change))
```

##Within men and women, are there differences (on average) between different smoking groups?
```{r}
# By gender and smoking status
lumbar_final %>% 
  group_by(gender, smoker) %>% 
  summarise(avg_odi_change = mean(odi_change))
```


## Graphically represent the spread of the change among men, women, and smokers
```{r}
# First pass
lumbar_final %>% 
  ggplot(aes(x = gender, 
             y = odi_change, 
             fill = smoker)) +
  geom_boxplot()
```

##What values do we need to be able to visualize on the y-axis?
```{r}
# What are the maximum and minimum values we need to be able to see?
lumbar_final %>% 
  summarise(max_change = max(odi_change),
            min_change = min(odi_change))

```

##Remake the graph
```{r}
# change the y-axis so we can see it
lumbar_final %>% 
  ggplot(aes(x = gender, y = odi_change, fill = smoker)) +
  geom_boxplot() +
  scale_y_continuous(breaks = seq(-110, 110, 10))
```

##What is the shape of the change in odi score

```{r}
# First pass
lumbar_final %>% 
  ggplot(aes(x = odi_change)) +
  geom_histogram()
```
##Do we actually have data at all of those values? Is the default bin size meaningful?
Let's remake the graph increasing the number of bins. But how many should we choose?
```{r}
# determine the number of unique values for odi_change
lumbar_final %>% 
  select(odi_change) %>% 
  n_distinct()
```

##Remake our histogram
```{r}
# Change the number of bins
lumbar_final %>% 
  ggplot(aes(x = odi_change)) +
  geom_histogram(bins = 133) +
  scale_x_continuous(breaks = seq(-100, 60, 10))
```


##Create a new variable based on both smoking status and diabetes 
```{r}
lumbar_final %>%
  mutate(smoker_diabetes = case_when(
    smoker == "previously smoker" & diabetes == "yes" ~ "previous_yes",
    smoker == "yes current" & diabetes == "yes" ~ "current_yes",
    smoker == "no" & diabetes == "yes" ~ "no_yes",
    smoker == "no" & diabetes == "no" ~ "no_no"
  )) %>% 
  select(smoker_diabetes)
```

##Why NA values?
Didn't specify all categories before
```{r}
lumbar_final %>%
  mutate(smoker_diabetes = case_when(
    smoker == "previously smoker" & diabetes == "yes" ~ "previous_yes",
    smoker == "yes current" & diabetes == "yes" ~ "current_yes",
    smoker == "no" & diabetes == "yes" ~ "no_yes",
    smoker == "no" & diabetes == "no" ~ "no_no",
    TRUE ~ "dont_care"
  )) %>% 
  select(smoker_diabetes)
```

##Faster way to do this if we want all combinations?
Absolutely
```{r}
lumbar_final <- lumbar_final %>%
  mutate(smoker_diabetes = interaction(smoker, diabetes))

lumbar_final %>% select(smoker_diabetes)
```
##How about a 3-way interaction between smoker, diabetes, and race?
```{r}
# Create 3-way interaction among race, diabetes, and smoker
lumbar_final %>% 
  mutate(smoker_diabetes_race = interaction(smoker, diabetes, race)) %>% 
  pull(smoker_diabetes_race) %>% 
  unique()
```


## Get the mean of every column that is numeric
```{r}
lumbar_final %>% 
  summarise_if(is.double, mean)
```

## Graphically, represent how preoperative and postoperative odi scores relate to smoking status and diabetes
```{r}
# Not helpful
lumbar_final %>% 
  ggplot() +
  geom_point(aes(x = odi_percent_preop, y = odi_percent_1yr, color = smoker_diabetes))
```

#Second attempt at above graph
```{r}
# better
lumbar_final %>% 
  ggplot() +
  geom_point(aes(x = odi_percent_preop, y = odi_percent_1yr)) +
  geom_abline(color = "blue") +
  facet_wrap( ~ smoker_diabetes)
```

